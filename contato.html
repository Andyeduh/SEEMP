<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ouvidoria — ChatBot Avançado</title>
<style>
:root{--azul:#0b5cff;--verde:#2ca58d;--vermelho:#d32f2f;--texto:#223046;--bg:#ffffff;}
*{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI,Roboto,Arial,sans-serif}
body{background:var(--bg);color:var(--texto);-webkit-font-smoothing:antialiased}
main{max-width:700px;margin:120px auto;padding:20px}
.chat-panel{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(34,48,70,0.06);display:flex;flex-direction:column;height:72vh;min-height:480px;max-height:82vh}
.messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:12px}
.msg{max-width:78%;padding:12px;border-radius:12px;line-height:1.45}
.msg.user{align-self:flex-end;background:linear-gradient(90deg,#e6f0ff,#fff);border:1px solid rgba(11,92,255,0.06)}
.msg.bot{align-self:flex-start;background:#f3f6fb;border:1px solid rgba(34,48,70,0.03)}
.input-area{display:flex;gap:8px;margin-top:12px}
.input-area textarea{flex:1;padding:10px;border-radius:10px;border:1px solid #e6eaf0;font-size:15px;min-height:48px;resize:vertical}
.send-btn{background:var(--azul);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer}
</style>
</head>
<body>

<main>
  <h1>Ouvidoria — ChatBot Avançado</h1>
  <p style="color:#6b7280">Converse com o ChatBot SEEMP. Ele lembra o contexto da conversa e responde de forma inteligente.</p>

  <div class="chat-panel" role="region" aria-label="Chat da ouvidoria">
    <div id="messages" class="messages" aria-live="polite">
      <div class="msg bot"><strong>ChatBot SEEMP:</strong><br>Olá! Sou seu assistente virtual. Como posso ajudá-lo hoje?</div>
    </div>

    <div class="input-area">
      <textarea id="userInput" placeholder="Digite sua dúvida"></textarea>
      <button id="sendBtn" class="send-btn">Enviar</button>
    </div>
  </div>
</main>

<script>
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');

// Carrega histórico do localStorage
let history = JSON.parse(localStorage.getItem('chat_history')) || [
  {role:'bot', text:'Olá! Sou seu assistente virtual. Como posso ajudá-lo hoje?'}
];

// Escapa HTML
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// Adiciona mensagem
function appendMessage(who, text){
  const div = document.createElement('div');
  div.className = 'msg ' + who;
  div.innerHTML = text;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Função avançada de resposta
function botReply(userText){
  userText = userText.toLowerCase();

  // Análise de histórico simples para contexto
  const context = history.map(m => m.text.toLowerCase()).join(" ");

  if(userText.includes("oi") || userText.includes("olá")) return "Oi! Como posso ajudar você hoje?";
  if(userText.includes("programa")) return "Temos vários programas para empreendedores. Quer que eu explique algum específico?";
  if(userText.includes("ajuda") || userText.includes("dúvida")) return "Claro! Me conte com detalhes sua dúvida para que eu possa ajudar melhor.";
  if(userText.includes("documento") || userText.includes("papel")) return "Você precisa de documentos específicos dependendo do setor. Quer que eu liste os principais?";
  if(userText.includes("horário") || userText.includes("atendimento")) return "Nosso horário de atendimento é de segunda a sexta, das 8h às 17h.";
  if(userText.includes("obrigatório")) return "Não, não é obrigatório, mas recomendamos seguir os procedimentos da SEEMP para melhores resultados.";

  // Resposta baseada em histórico
  if(context.includes("programa") && userText.includes("explicar")) return "Claro! Por exemplo, temos o Programa de Microcrédito e o Programa de Capacitação para empreendedores.";
  
  // Resposta padrão
  return "Desculpe, não entendi completamente. Pode reformular ou ser mais específico?";
}

// Envia mensagem
function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  appendMessage('user', `<strong>Você:</strong><br>${escapeHtml(text)}`);
  history.push({role:'user', text});
  inputEl.value = '';

  appendMessage('bot', `<strong>ChatBot SEEMP:</strong><br><em>Digitando...</em>`);

  setTimeout(()=>{
    messagesEl.lastChild.remove(); // remove "digitando"
    const reply = botReply(text);
    appendMessage('bot', `<strong>ChatBot SEEMP:</strong><br>${escapeHtml(reply)}`);
    history.push({role:'bot', text:reply});
    localStorage.setItem('chat_history', JSON.stringify(history));
  }, 800);
}

// Renderiza histórico
history.forEach(m=>{
  appendMessage(m.role==='user'?'user':'bot', `<strong>${m.role==='user'?'Você':'ChatBot SEEMP'}:</strong><br>${escapeHtml(m.text)}`);
});

sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
</script>

</body>
</html>